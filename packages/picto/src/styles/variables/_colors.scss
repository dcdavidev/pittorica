@use 'sass:color';
@use 'sass:list';
@use 'sass:map';
@use 'sass:math';
@use 'sass:meta';

$color-token-names:
  'primary', 'secondary', 'tertiary', 'neutral', 'neutral-variant', 'error',
  'success', 'info', 'danger';

/* Canonical white/black */
$white: #ffffff;
$black: #000000;

/* Base colors (the “50” point) */
$base: (
  primary: #08a4bd,
  secondary: #d87cac,
  tertiary: #9e7682,
  neutral: #787579,
  neutral-variant: #6a6670,
  error: #bb0a1e,
  success: #28a745,
  info: #0099ff,
  danger: #dc4c26,
);

/* -------------------------------------------------------
   Relative luminance + Contrast
------------------------------------------------------- */

@function _luminance($c) {
  $rgb: (
    math.div(color.channel($c, 'red', $space: rgb), 255),
    math.div(color.channel($c, 'green', $space: rgb), 255),
    math.div(color.channel($c, 'blue', $space: rgb), 255)
  );
  $lin: ();

  @each $ch in $rgb {
    $lin: list.append(
      $lin,
      if(
        $ch < 0.03928,
        math.div($ch, 12.92),
        math.pow(math.div($ch + 0.055, 1.055), 2.4)
      )
    );
  }

  @return list.nth($lin, 1) * 0.2126 + list.nth($lin, 2) * 0.7152 +
    list.nth($lin, 3) * 0.0722;
}

@function contrast($c1, $c2) {
  $l1: _luminance($c1);
  $l2: _luminance($c2);
  $light: math.max($l1, $l2);
  $dark: math.min($l1, $l2);
  @return math.div($light + 0.05, $dark + 0.05);
}

@function generate-scale-m3($base) {
  $scale: ();

  @for $i from 0 through 10 {
    $step: $i * 10;

    @if $step < 50 {
      $ratio: (50 - $step) * 2%; // darker
      $scale: map.set($scale, $step, color.mix($black, $base, $ratio));
    } @else if $step > 50 {
      $ratio: ($step - 50) * 2%; // lighter
      $scale: map.set($scale, $step, color.mix($white, $base, $ratio));
    } @else {
      $scale: map.set($scale, 50, $base);
    }
  }

  @return $scale;
}

$color-scales: ();

@each $name, $base-color in $base {
  $color-scales: map.set($color-scales, $name, generate-scale-m3($base-color));
}

@function color-token($name, $step: 50) {
  $scale: map.get($color-scales, $name);

  @if meta.type-of($scale) != 'map' {
    @error "color-token(): '#{$name}' has no scale.";
  }

  @if map.has-key($scale, $step) {
    @return map.get($scale, $step);
  }

  @error "color-token(): Step '#{$step}' undefined for '#{$name}'.";
}

@function on-color($bg) {
  $light: $white;
  $dark: $black;

  @return if(contrast($dark, $bg) >= 4.5, $dark, $light);
}

@function container-token($name, $level: 70) {
  @return color-token($name, $level);
}

@function on-container-token($name, $level: 70) {
  @return on-color(container-token($name, $level));
}

$semantic-tokens: ();

@each $name in $color-token-names {
  $bg: color-token($name, 50);
  $on: on-color($bg);
  $container: container-token($name, 80);
  $on-container: on-container-token($name, 80);

  $semantic-tokens: map.merge(
    $semantic-tokens,
    (
      #{$name}: $bg,
      on-#{$name}: $on,
      #{$name}-container: $container,
      on-#{$name}-container: $on-container
    )
  );
}

@function semantic-token($role) {
  @if map.has-key($semantic-tokens, $role) {
    @return map.get($semantic-tokens, $role);
  }

  @error "semantic-token(): Unknown role '#{$role}'.";
}

@function invert-step($step) {
  @return 100 - $step;
}

@mixin color-scheme($mode: light) {
  $neutral: map.get($color-scales, neutral);

  @if $mode == light {
    --surface-bg: #{map.get($neutral, 100)};
    --surface-fg: #{map.get($neutral, 10)};
    --surface-border: #{map.get($neutral, 30)};
  }

  @if $mode == dark {
    --surface-bg: #{map.get($neutral, 0)};
    --surface-fg: #{map.get($neutral, 90)};
    --surface-border: #{map.get($neutral, 70)};
  }
}
